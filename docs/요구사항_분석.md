# 요구사항 분석

## 핵심 요구사항

- 거래를 진행할 때 오류가 발생하지 않는 것이 가장 중요하다.
- 하지만, 오류가 발생하더라도 어느 시점에서 발생했는지 파악할 수 있어야 한다.

### 돈 관련 타입 (BigDecimal vs Double vs Long)

- 현재 요구사항에는 결제 후 페이백을 지급하는 비즈니스 로직이 존재한다.
- 페이백이 고정된 값 (ex. 1000원)이 아닌, 일정 비율로 제공되어야 할 경우라면?
- float, double은 부동소수점 방식으로 인해 정확한 계산이 불가능함.
- BigDecimal은 정확한 계산이 가능하나, 무거운 객체이기 때문에 성능적인 측면에서 고려해야 함.

부동소수점의 한계를 가진 float, double을 사용하는 것은 적절하지 않은 것 같음.
할인율이나 페이백의 요구사항이 변경될 수 있다는 점 등 확장성을 고려하여 BigDecimal을 사용하는 것이 적절해보임.

성능적 측면에서 무거운 객체를 사용한다는 점은 문제가 되지만, '돈'과 관련된 API에선 정확성이 최우선이라고 판단

## 유저

> MySQL에서는 `user`라는 키워드가 존재하기 때문에 `member`로 대체합니다.

- 현재 보유 금액
- 상태 (가입 / 탈퇴)
- 보유 가능한 최대 한도가 존재 (유저마다 다름)
- 1회/1일/1달 결제 한도가 존재

### 나의 접근 방법

- 상태를 나타내는 변수 (`isDeleted`)를 Soft Delete 하는 방식으로 적용
- 결제 한도 필드 (`xxxLimit`) 를 통해 결제를 진행할 때 체크
- 또한, 일/월 누적 금액을 저장하는 필드 (`xxxAccumulate`) 를 통해 결제를 진행할 때 체크
- 누적 금액은 Spring Scheduling Task (`@Scheduler`) 사용하여 누적 금액 초기화

> 머니 결제 API 요청시 발생할 수 있는 예외
> 1. 잔액 부족
> 2. 1회 결제 한도 초과 (onceLimit)
> 3. 1일 결제 한도 초과 (dailyLimit)
> 4. 1달 결제 한도 초과 (monthlyLimit)

## 거래 (결제/페이백)

- 중복 요청을 하는 상황 등 어떤 상황에서든 결제는 **1건당 1회!**
- 결제 실패시 **어느 시점**에서 실패했는지 파악 가능하게
- 결제와 페이백은 `1:1 관계`라고 생각하였지만, 하나의 테이블에 저장하도록 진행
    - @OneToOne 연관관계를 사용할 수도 있지만, LAZY Loading이 안되는 점, 조회의 편의성 등을 고려하였습니다.
- 또한, 회원의 정보는 ID만 저장하고, Entity Mapping 없이 진행

#### 나의 생각

- 높은 격리 수준(**REPEATABLE READ**)을 사용
- `Lock` 을 사용하여 접근 권한을 제한하는 방식 사용
- 결제/페이백 시스템에서 `동시성 제어`가 가장 핵심적으로 판단
- 격리 수준과 락에 따른 **trade-off (dead lock)** 대응 방법은?

> **'결제 후 페이백을 진행한다.'**
> 1. 클라이언트가 결제 API 호출을 하면 서버 내부적으로 페이백까지 한 트랜잭션으로 처리
> 2. **클라이언트가 결제 API 호출 후 정상 응답일 경우 페이백 API 호출** &larr; 이 방식으로 이해하고 진행하였습니다.

### 결제

- 결제 금액만큼 유저의 보유 금액(`balance`)을 차감합니다.
- 또한, 누적 금액에 결제 금액을 더합니다.
- 결제를 요청할 때 결제 금액과 페이백 금액을 함께 요청합니다.

```http request
POST /api/v1/members/{memberId}/payments
Content-Type: application/json

{
  "paymentAmount": 10000,
  "paybackAmount": 1000
}
```

_예외 사항_

- 1회 결제 한도 초과
    - 유저의 1회 결제 한도와 결제 금액을 비교하여 초과했는지 확인
- 1일/1달 결제 한도
    - 유저의 누적 결제 금액과 비교하여 초과했는지 확인
- 잔액 부족
    - 유저의 현재 보유 금액과 결제 금액을 비교하여 부족한지 확인

### 결제 취소

- 결제가 완료된 건에 대해서만 취소를 진행할 수 있도록 합니다.
- 페이백이 진행된 결제건일 경우 페이백 또한 같이 취소됩니다.
- 결제 금액만큼 유저의 보유 금액(`balance`)을 증가합니다.
- 또한, 결제 일자와 취소를 요청한 시점이 같은 일, 같은 달인 경우 누적 금액을 수정합니다.

```http request
DELETE /api/v1/members/{memberId}/payments/{paymentId}/cancel
Content-Type: application/json

```

### 페이백

- 결제가 완료된 건에 대해서만 페이백을 진행할 수 있도록 합니다.
- 결제 요청에서 받았던 페이백 금액만큼 유저의 보유 금액(`balance`)을 증가합니다.

```http request
POST /api/v1/payments/{paymentId}/payback
Content-Type: application/json
```

