# 요구사항 분석

## 핵심 요구사항

- 거래를 진행할 때 오류가 발생하지 않는 것이 가장 중요하다.
- 하지만, 오류가 발생하더라도 어느 시점에서 발생했는지 파악할 수 있어야 한다.

## 유저

> MySQL에서는 `user`라는 키워드가 존재하기 때문에 `member`로 대체합니다.

- 현재 보유 금액
- 상태 (가입 / 탈퇴)
- 보유 가능한 최대 한도가 존재 (유저마다 다름)
- 1회/1일/1달 결제 한도가 존재

#### 나의 접근 방법

- 상태를 나타내는 변수 (`isDeleted`)를 Soft Delete 하는 방식으로 적용
- 결제 한도 필드 (`xxxLimit`) 를 통해 결제를 진행할 때 체크
- 또한, 일/월 누적 금액을 저장하는 필드 (`xxxAccumulate`) 를 통해 결제를 진행할 때 체크
- 누적 금액은 Spring Scheduling Task (`@Scheduler`) 사용하여 누적 금액 초기화

> 머니 결제 API 요청시 발생할 수 있는 예외
> 1. 잔액 부족
> 2. 1회 결제 한도 초과 (onceLimit)
> 3. 1일 결제 한도 초과 (dailyLimit)
> 4. 1달 결제 한도 초과 (monthlyLimit)

## 거래 (결제/페이백)

- 중복 요청을 하는 상황 등 어떤 상황에서든 결제는 **1건당 1회!**
- 결제 실패시 **어느 시점**에서 실패했는지 파악 가능하게
- 결제와 페이백은 `1:1 관계`라고 생각하였지만, 하나의 테이블에 저장하도록 진행
    - @OneToOne 연관관계를 사용할 수도 있지만, LAZY Loading이 안되는 점, 조회의 편의성 등을 고려하였습니다.
- 또한, 회원의 정보는 ID만 저장하고, Entity Mapping 없이 진행

#### 나의 접근 방법

- 높은 격리 수준(**REPEATABLE READ**)을 사용
- `Lock` 을 사용하여 접근 권한을 제한하는 방식 사용
- 결제/페이백 시스템에서 `동시성 제어`가 가장 핵심적으로 판단
- 격리 수준과 락에 따른 **trade-off (dead lock)** 대응 방법은?

> **'결제 후 페이백을 진행한다.'**
> 1. 클라이언트가 결제 API 호출을 하면 서버 내부적으로 페이백까지 한 트랜잭션으로 처리
> 2. **클라이언트가 결제 API 호출 후 정상 응답일 경우 페이백 API 호출** &larr; 이 방식으로 이해하고 진행하였습니다.

### 결제

- 결제 금액만큼 유저의 보유 금액(`balance`)을 차감합니다.
- 또한, 누적 금액에 결제 금액을 더합니다.
- 결제를 요청할 때 결제 금액과 페이백 금액을 함께 요청합니다.

_예외 사항_

- 1회 결제 한도 초과
    - 유저의 1회 결제 한도와 결제 금액을 비교하여 초과했는지 확인
- 1일/1달 결제 한도
    - 유저의 누적 결제 금액과 비교하여 초과했는지 확인
- 잔액 부족
    - 유저의 현재 보유 금액과 결제 금액을 비교하여 부족한지 확인

### 결제 취소

- 결제가 완료된 건에 대해서만 취소를 진행할 수 있도록 합니다.
- 페이백이 진행된 결제건일 경우 페이백 또한 같이 취소됩니다.
- 결제 금액만큼 유저의 보유 금액(`balance`)을 증가합니다.
- 또한, 결제 일자와 취소를 요청한 시점이 같은 일, 같은 달인 경우 누적 금액을 수정합니다.

_예외 사항_

- 보유 한도 초과
    - 취소 후 유저가 보유한 금액이 한도를 초과하는지 확인

_특이 사항_

- 페이백 완료 상태
    - 결제 취소 시 페이백이 완료된 상태라면 페이백 취소도 같이 진행합니다.
    - 이 과정에서의 문제점이 존재하여 [생각정리 - 결제 취소와 페이백 취소](생각정리.md)에 기록

### 페이백

- 결제가 완료된 건에 대해서만 페이백을 진행할 수 있도록 합니다.
- 결제 요청에서 받았던 페이백 금액만큼 유저의 보유 금액(`balance`)을 증가합니다.

_예외 사항_

- 결제 상태 확인
    - 결제가 성공적으로 완료된 건에 대해서만 페이백을 진행

- 보유 한도 초과
    - 페이백 후 유저가 보유한 금액이 한도를 초과하는지 확인


### 페이백 취소

- 페이백이 완료된 건에 대해서만 취소를 진행할 수 있도록 합니다.
- 페이백 금액만큼 유저의 보유 금액을 차감합니다.

_예외 사항_

- 보유 금액 부족
  - 페이백을 취소할 경우 유저의 보유 금액을 차감해야 함
  - 이 때, 보유 금액이 음수가 되는지 확인이 필요

_특이 사항_

- 페이백 금액이 0원 이상인 경우에만 유저 보유 금액을 차감
