# 트러블 슈팅

## 1. 누적 금액 초기화 (JPQL)

```java
public interface MemberRepository extends JpaRepository<Member, Long> {

    @Modifying
    @Query("UPDATE Member m SET m.dailyAccumulate = 0")
    void resetDailyLimit();

    @Modifying
    @Query("UPDATE Member m SET m.monthlyAccumulate = 0")
    void resetMonthlyLimit();
}
```

회원의 일일/월별 누적 금액을 매일/매월 초기화시켜주는 쿼리를 작성하였습니다. _(Scheduler를 사용하여 매일/매월 초기화)_

- 작성한 후 과거에 `JPQL`을 사용할 때 주의해야되는 점이 '영속성 컨텍스트'를 사용하여 1차 캐싱하는 것이었습니다.
- `@Modifying` 어노테이션의 **clearAutomatically** 값을 true로 설정하면, 해당 쿼리를 실행 후 영속성 컨텍스트를 clear 하는 과정이 진행되어 데이터 불일치를 방지할 수 있습니다.

#### JPQL을 사용한 이유

- JPQL을 사용할 경우, 유지보수에 유연하며 코드 작성 시점에 오류를 잡을 수 있습니다.
- 또한, 객체지향적인 코드를 작성하고, DB에 종속되지 않는 코드를 작성할 수 있습니다.
- 결정적으로, **Soft Delete**를 사용하기 때문에, 탈퇴한 회원에 대한 불필요한 처리가 발생하지 않습니다.

- 물론, 속도적 측면에서 nativeQuery가 빠르고, Querydsl을 사용하여 컴파일 시점에 오류를 잡을 수 있지만, 단순 쿼리문 작성 시에는 JPQL을 사용하는 것이 유리하다고 판단하였습니다.